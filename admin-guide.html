<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    
    <link rel="canonical" href="https://carv-ics-forth.github.io/HPK/docs/admin-guide.html">
    <link rel="shortcut icon" href="img/favicon.ico">

    
    <title>Admin Guide - HPK Documentation</title>
    

    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.12.0/css/all.css">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.12.0/css/v4-shims.css">
    <link rel="stylesheet" href="//cdn.jsdelivr.net/npm/hack-font@3.3.0/build/web/hack.min.css">
    <link href='//rsms.me/inter/inter.css' rel='stylesheet' type='text/css'>
    <link href='//fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,700italic,400,300,600,700&subset=latin-ext,latin' rel='stylesheet' type='text/css'>
    <link href="css/bootstrap-custom.min.css" rel="stylesheet">
    <link href="css/base.min.css" rel="stylesheet">
    <link href="css/cinder.min.css" rel="stylesheet">

    
        
        <link rel="stylesheet" href="//cdn.jsdelivr.net/gh/highlightjs/cdn-release@9.18.0/build/styles/github.min.css">
        
    
    <link href="css/extra.css" rel="stylesheet">

    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
            <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
            <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
        <![endif]-->

    

     
</head>

<body>

    <div class="navbar navbar-default navbar-fixed-top" role="navigation">
    <div class="container">

        <!-- Collapsed navigation -->
        <div class="navbar-header">
            <!-- Expander button -->
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            

            <!-- Main title -->

            
              <a class="navbar-brand" href="index.html">HPK Documentation</a>
            
        </div>

        <!-- Expanded navigation -->
        <div class="navbar-collapse collapse">
                <!-- Main navigation -->
                <ul class="nav navbar-nav">
                
                
                    <li >
                        <a href="index.html">Overview</a>
                    </li>
                
                
                
                    <li class="active">
                        <a href="admin-guide.html">Admin Guide</a>
                    </li>
                
                
                
                    <li >
                        <a href="examples.html">Examples</a>
                    </li>
                
                
                </ul>

            <ul class="nav navbar-nav navbar-right">
                    <li >
                        <a rel="prev" href="index.html">
                            <i class="fas fa-arrow-left"></i> Previous
                        </a>
                    </li>
                    <li >
                        <a rel="next" href="examples.html">
                            Next <i class="fas fa-arrow-right"></i>
                        </a>
                    </li>
                    <li>
                        <a href="https://github.com/CARV-ICS-FORTH/HPK/edit/master/docs/admin-guide.md"><i class="fab fa-github"></i> Edit on GitHub</a>
                    </li>
            </ul>
        </div>
    </div>
</div>

    <div class="container">
        
        
        <div class="col-md-3"><div class="bs-sidebar hidden-print affix well" role="complementary">
    <ul class="nav bs-sidenav">
        <li class="first-level active"><a href="#admin-guide">Admin Guide</a></li>
            <li class="second-level"><a href="#requirements">Requirements</a></li>
                
                <li class="third-level"><a href="#install-etcd">Install etcd</a></li>
                <li class="third-level"><a href="#install-apptainer">Install Apptainer</a></li>
                <li class="third-level"><a href="#install-flannel">Install Flannel</a></li>
                <li class="third-level"><a href="#configure-apptainer-to-use-flannel-as-a-cni-plugin">Configure Apptainer to use flannel as a CNI plugin</a></li>
                <li class="third-level"><a href="#install-utilities">Install Utilities</a></li>
            <li class="second-level"><a href="#hpk-installation-setup">HPK Installation &amp; Setup</a></li>
                
            <li class="second-level"><a href="#test">Test</a></li>
                
    </ul>
</div></div>
        <div class="col-md-9" role="main">

<h1 id="admin-guide">Admin Guide</h1>
<p>In this tutorial, we'll walk you through the setup process to get HPK up and operational.</p>
<blockquote>
<p>Tested on Ubuntu 20.04, CentOS 7.</p>
</blockquote>
<h2 id="requirements">Requirements</h2>
<table>
<thead>
<tr>
<th>Variable</th>
<th>Version</th>
</tr>
</thead>
<tbody>
<tr>
<td>APPTAINER_VERSION</td>
<td>1.1.4</td>
</tr>
<tr>
<td>FLANNEL_VERSION</td>
<td>0.20.2</td>
</tr>
<tr>
<td>FLANNEL_CNI_PLUGIN_VERSION</td>
<td>1.1.2</td>
</tr>
<tr>
<td>KUBERNETES_VERSION</td>
<td>1.24.8</td>
</tr>
<tr>
<td>HELM_VERSION</td>
<td>3.10.3</td>
</tr>
</tbody>
</table>
<p>Set environment variables:</p>
<pre><code class="language-bash">APPTAINER_VERSION=1.1.4
FLANNEL_VERSION=0.20.2
FLANNEL_CNI_PLUGIN_VERSION=1.1.2
KUBERNETES_VERSION=1.24.8
HELM_VERSION=3.10.3

HOST_ADDRESS=$(ip route get 1 | sed -n 's/.*src \([0-9.]\+\).*/\1/p')
SLURM_CONFIG=/etc/slurm/slurm.conf
ETCD_ADDRESS=`cat ${SLURM_CONFIG} | grep SlurmctldHost | awk -F '[()]' '{print $2}'`
</code></pre>
<p>Install wget utility:</p>
<pre><code class="language-bash">if [[ &quot;$(. /etc/os-release; echo $ID)&quot; == &quot;ubuntu&quot; ]]; then
    apt-get update
    apt-get install -y wget
else
    yum install -y wget
fi
</code></pre>
<h3 id="install-etcd">Install <a href="https://etcd.io/">etcd</a></h3>
<blockquote>
<p>On one host</p>
</blockquote>
<p>We use etcd, a key-value store that will be used by flannel later.</p>
<p>Setup etcd service and fire it up:</p>
<pre><code class="language-bash">if [[ &quot;$HOST_ADDRESS&quot; == &quot;$ETCD_ADDRESS&quot; ]]; then
    if [[ &quot;$(. /etc/os-release; echo $ID)&quot; == &quot;ubuntu&quot; ]]; then
        apt-get install -y etcd-server etcd-client
        cat &gt;&gt;/etc/default/etcd &lt;&lt;EOF
ETCD_LISTEN_CLIENT_URLS=&quot;http://${HOST_ADDRESS}:2379&quot;
ETCD_ADVERTISE_CLIENT_URLS=&quot;http://${HOST_ADDRESS}:2379&quot;
EOF
    else
        yum install -y etcd
        sed -i &quot;s/localhost:2379/${HOST_ADDRESS}:2379/&quot; /etc/etcd/etcd.conf
    fi

    systemctl enable etcd
    systemctl restart etcd

    export ETCDCTL_API=3
    etcdctl --endpoints http://${HOST_ADDRESS}:2379 put /coreos.com/network/config '{&quot;Network&quot;: &quot;10.244.0.0/16&quot;, &quot;Backend&quot;: {&quot;Type&quot;: &quot;vxlan&quot;}}'
fi
</code></pre>
<h3 id="install-apptainer">Install <a href="https://apptainer.org/">Apptainer</a></h3>
<blockquote>
<p>On all hosts</p>
</blockquote>
<pre><code class="language-bash">if [[ &quot;$(. /etc/os-release; echo $ID)&quot; == &quot;ubuntu&quot; ]]; then
    wget -q https://github.com/apptainer/apptainer/releases/download/v${APPTAINER_VERSION}/apptainer_${APPTAINER_VERSION}_amd64.deb
    wget -q https://github.com/apptainer/apptainer/releases/download/v${APPTAINER_VERSION}/apptainer-suid_${APPTAINER_VERSION}_amd64.deb
    apt-get install -y ./apptainer_${APPTAINER_VERSION}_amd64.deb ./apptainer-suid_${APPTAINER_VERSION}_amd64.deb
    rm -f apptainer_${APPTAINER_VERSION}_amd64.deb apptainer-suid_${APPTAINER_VERSION}_amd64.deb
else
    wget -q https://github.com/apptainer/apptainer/releases/download/v${APPTAINER_VERSION}/apptainer-${APPTAINER_VERSION}-1.x86_64.rpm
    wget -q https://github.com/apptainer/apptainer/releases/download/v${APPTAINER_VERSION}/apptainer-suid-${APPTAINER_VERSION}-1.x86_64.rpm
    yum install -y epel-release
    yum install -y fuse2fs
    yum install -y ./apptainer-${APPTAINER_VERSION}-1.x86_64.rpm ./apptainer-suid-${APPTAINER_VERSION}-1.x86_64.rpm
    rm -f apptainer-${APPTAINER_VERSION}-1.x86_64.rpm apptainer-suid-${APPTAINER_VERSION}-1.x86_64.rpm

    echo &quot;user.max_user_namespaces=15000&quot; &gt; /etc/sysctl.d/90-max_user_namespaces.conf
    sysctl -p /etc/sysctl.d/90-max_user_namespaces.conf
fi
</code></pre>
<h3 id="install-flannel">Install <a href="https://github.com/flannel-io/flannel">Flannel</a></h3>
<blockquote>
<p>On all hosts</p>
</blockquote>
<p>Flannel runs a small, single binary agent called flanneld on each host, and is responsible for allocating a subnet lease to each host out of a larger, preconfigured address space. Flannel uses either the Kubernetes API or etcd directly to store the network configuration, the allocated subnets, and any auxiliary data (such as the host's public IP). Packets are forwarded using one of several backend mechanisms including VXLAN and various cloud integrations.</p>
<p>To install:</p>
<pre><code class="language-bash">if [[ &quot;$(. /etc/os-release; echo $ID)&quot; == &quot;ubuntu&quot; ]]; then
    apt-get install -y nscd # https://github.com/flannel-io/flannel/issues/1512
fi

wget -q https://github.com/flannel-io/flannel/releases/download/v${FLANNEL_VERSION}/flanneld-amd64
chmod +x flanneld-amd64
cp flanneld-amd64 /usr/local/bin/flanneld
rm -f flanneld-amd64
</code></pre>
<p>Now setup the flannel service and fire it up:</p>
<pre><code class="language-bash">cat &gt;/etc/systemd/system/flanneld.service &lt;&lt;EOF
[Unit]
Description=flannel daemon

[Service]
ExecStart=/usr/local/bin/flanneld -etcd-endpoints http://${ETCD_ADDRESS}:2379 -ip-masq
Restart=always

[Install]
WantedBy=multi-user.target
EOF
systemctl daemon-reload
systemctl enable flanneld
systemctl start flanneld
</code></pre>
<h3 id="configure-apptainer-to-use-flannel-as-a-cni-plugin">Configure Apptainer to use flannel as a CNI plugin</h3>
<blockquote>
<p>On all hosts</p>
</blockquote>
<p>First we download and install Flannel binary</p>
<pre><code class="language-bash">wget -q https://github.com/flannel-io/cni-plugin/releases/download/v${FLANNEL_CNI_PLUGIN_VERSION}/flannel-amd64
chmod +x flannel-amd64
cp flannel-amd64 /usr/libexec/apptainer/cni/flannel
rm -f flannel-amd64
</code></pre>
<p>Then we configure Apptainer to use Flannel as a CNI plug-in for fakeroot runs</p>
<pre><code class="language-bash">cat &gt; /etc/apptainer/network/40_fakeroot.conflist &lt;&lt;EOF
{
    &quot;cniVersion&quot;: &quot;1.0.0&quot;,
    &quot;name&quot;: &quot;fakeroot&quot;,
    &quot;plugins&quot;: [
        {
            &quot;type&quot;: &quot;flannel&quot;,
            &quot;delegate&quot;: {
                &quot;isDefaultGateway&quot;: true
            }
        },
        {
            &quot;type&quot;: &quot;firewall&quot;
        },
        {
            &quot;type&quot;: &quot;portmap&quot;,
            &quot;capabilities&quot;: {&quot;portMappings&quot;: true},
            &quot;snat&quot;: true
        }
    ]
}
EOF
</code></pre>
<blockquote>
<p>In case there is a problem using these CNI plugins as a regular user you can additionally setup apptainer with the following:</p>
</blockquote>
<pre><code class="language-bash">cat &gt;&gt;/etc/apptainer/apptainer.conf &lt;&lt;EOF
allow net users = &lt;??&gt;
allow net groups = &lt;??&gt;
allow net networks = bridge, flannel
EOF
</code></pre>
<h3 id="install-utilities">Install Utilities</h3>
<ul>
<li>Kubectl utility with the same version as the Kubernetes</li>
</ul>
<pre><code class="language-bash">wget -q https://dl.k8s.io/v${KUBERNETES_VERSION}/bin/linux/amd64/kubectl
chmod +x kubectl
cp kubectl /usr/local/bin/kubectl
rm -f kubectl
</code></pre>
<ul>
<li>Helm utility</li>
</ul>
<pre><code class="language-bash">wget -q https://get.helm.sh/helm-v${HELM_VERSION}-linux-amd64.tar.gz
tar -zxvf helm-v${HELM_VERSION}-linux-amd64.tar.gz --strip-components=1 linux-amd64/helm
cp helm /usr/local/bin/helm
rm -f helm helm-v${HELM_VERSION}-linux-amd64.tar.gz
</code></pre>
<h2 id="hpk-installation-setup">HPK Installation &amp; Setup</h2>
<p>Back to the head node, as the local user:</p>
<pre><code class="language-sh">git clone https://github.com/CARV-ICS-FORTH/HPK.git
cd HPK

# Download the hpk-kubelet binary (adjust the version in the URL)
wget https://github.com/CARV-ICS-FORTH/HPK/releases/download/v0.1.0/hpk-kubelet_v0.1.0_linux_amd64.tar.gz
tar -zxvf hpk-kubelet_v0.1.0_linux_amd64.tar.gz
mkdir -p bin
mv hpk-kubelet bin/
</code></pre>
<p>Run each of the following in a separate window:</p>
<pre><code class="language-sh">make run-kubemaster
make run-kubelet
</code></pre>
<p>Running the above commands, respectively:
<img alt="After deploying kubernetes" src="images/run-kubemaster.png" /></p>
<p><img alt="After deploying HPK" src="images/run-kubelet.png" /></p>
<p>And you are all set:</p>
<pre><code class="language-sh">export KUBE_PATH=~/.k8sfs/kubernetes/
export KUBECONFIG=${KUBE_PATH}/admin.conf
kubectl get nodes
</code></pre>
<p><img alt="After getting-nodes" src="images/get-nodes.png" /></p>
<h2 id="test">Test</h2>
<p>To test that everything is running correctly:</p>
<pre><code class="language-bash">make test
</code></pre>
<p><img alt="" src="images/make-test.png" /></p></div>
        
        
    </div>

    
      <footer class="col-md-12 text-center">
          
          
            <hr>
            <p>
            <small>Â© 2020-2023, FORTH-ICS</small><br>
            
            <small>Documentation built with <a href="http://www.mkdocs.org/">MkDocs</a>.</small>
            </p>
          

          
          
      </footer>
    
    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
    <script src="js/bootstrap-3.0.3.min.js"></script>

    
    <script src="//cdn.jsdelivr.net/gh/highlightjs/cdn-release@9.18.0/build/highlight.min.js"></script>
        
    <script>hljs.initHighlightingOnLoad();</script>
    

    <script>var base_url = "."</script>
    
    <script src="js/base.js"></script>

    <div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="keyboardModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="keyboardModalLabel">Keyboard Shortcuts</h4>
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>
    </body>

</html>
